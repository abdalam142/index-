<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>بحث في ملف Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; direction: rtl; }
    #searchBar { width: 50%; padding: 10px; font-size: 16px; margin-top: 20px; }
    table { width: 80%; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }

    /* مؤشر الحالة */
    #statusBox {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: red; /* افتراضي: أحمر */
      border: 2px solid #333;
    }
  </style>
</head>
<body>
  <h2>بحث في ملف Excel</h2>
  
  <!-- مؤشر الحالة -->
  <div id="statusBox" title="ملف Excel غير متصل"></div>

  <select id="sheetSelect"></select>
  <br>
  <input type="text" id="searchBar" placeholder="اكتب الاسم أو الباركود أو الوصف واضغط إنتر">
  <table id="results"></table>

  <script>
    let excelData = {};
    let selectedSheet = "";

    async function loadExcelFromGitHub() {
      try {
        const response = await fetch("data.xlsx"); // الملف جنب index.html في الريبو
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });

        const sheetSelect = document.getElementById('sheetSelect');
        sheetSelect.innerHTML = '';
        workbook.SheetNames.forEach(name => {
          let option = document.createElement('option');
          option.value = name;
          option.text = name;
          sheetSelect.appendChild(option);
        });
        selectedSheet = workbook.SheetNames[0];

        workbook.SheetNames.forEach(sheetName => {
          const sheet = workbook.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
          excelData[sheetName] = rows;
        });

        // ✅ الملف اتحمل بنجاح
        const statusBox = document.getElementById("statusBox");
        statusBox.style.backgroundColor = "green";
        statusBox.title = "ملف Excel متصل";
      } catch (err) {
        console.error("خطأ في تحميل ملف الإكسل:", err);
        // ❌ فشل التحميل → يبقى أحمر
        const statusBox = document.getElementById("statusBox");
        statusBox.style.backgroundColor = "red";
        statusBox.title = "ملف Excel غير متصل";
      }
    }

    function search() {
      const query = document.getElementById('searchBar').value.trim().toLowerCase();
      if (!query || !selectedSheet) return;

      const rows = excelData[selectedSheet];
      const resultsTable = document.getElementById('results');
      resultsTable.innerHTML = '';

      // الهيدر
      let headerRow = `<tr><th>A</th><th>B</th><th>C</th><th>D</th></tr>`;
      resultsTable.innerHTML = headerRow;

      rows.forEach((row, index) => {
        if (index === 0) return; // تخطي الصف الأول (العناوين)
        let a = (row[0] || "").toString().toLowerCase();
        let b = (row[1] || "").toString();
        let c = (row[2] || "").toString().toLowerCase();
        let d = (row[3] || "").toString().toLowerCase();

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          let tr = `<tr>
                      <td>${row[0] || ''}</td>
                      <td>${row[1] || ''}</td>
                      <td>${row[2] || ''}</td>
                      <td>${row[3] || ''}</td>
                    </tr>`;
          resultsTable.innerHTML += tr;
        }
      });
    }

    document.getElementById('sheetSelect').addEventListener('change', () => {
      selectedSheet = document.getElementById('sheetSelect').value;
    });
    document.getElementById('searchBar').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') search();
    });

    // تحميل الملف أوتوماتيك عند فتح الصفحة
    window.onload = loadExcelFromGitHub;
  </script>
</body>
</html>
