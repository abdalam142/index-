<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>
  <style>
    :root {
      --card-bg: #ffffff;
      --muted: #6c757d;
      --primary: #0d6efd;
      --success: #28a745;
      --danger: #dc3545;
      --accent: #20c997;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f6f7fb;
      color: #222;
      margin: 0;
      padding: 18px;
      box-sizing: border-box;
      direction: rtl;
    }
    h2 { text-align: center; margin: 6px 0 12px; }
    #status {
      position: fixed;
      top: 12px;
      right: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-weight: 700;
      z-index: 60;
    }
    #status.active { background: var(--success); }
    #status.inactive { background: var(--danger); }
    #loginBox {
      background: var(--card-bg);
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      max-width: 420px;
      margin: 10px auto;
      text-align: center;
    }
    #passwordInput {
      width: 100%;
      max-width: 260px;
      padding: 10px;
      font-size: 20px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .numpad {
      width: 260px;
      margin: 12px auto 0;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .numpad button {
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f3f3f3;
      cursor: pointer;
    }
    #passError {
      display: none;
      margin-top: 10px;
      color: #842029;
      background: #f8d7da;
      border: 1px solid #f5c2c7;
      padding: 8px 10px;
      border-radius: 6px;
      width: 90%;
      max-width: 320px;
      margin-inline: auto;
      box-sizing: border-box;
    }
    #app {
      display: none;
      margin-top: 14px;
    }
    .searchRow {
      text-align: center;
      margin-bottom: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .searchControls {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-direction: row-reverse;
    }
    #searchBar {
      width: 60%;
      max-width: 520px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      display: inline-block;
    }
    .btn {
      padding: 10px 14px;
      margin: 0 6px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.ghost { background: #e9ecef; }
    .btn.camera { background: var(--accent); color: #fff; }
    .btn.scale-active { background: #ffc107; color: #111; }
    .btn.focus-on { background: #198754; color: #fff; }
    .btn.focus-off { background: #6c757d; color: #fff; }
    #reader {
      width: 320px;
      margin: 10px auto;
      display: none;
    }
    .tables {
      display: flex;
      gap: 18px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .col {
      width: 48%;
      background: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word;
    }
    thead th {
      background: #f2f2f2;
      padding: 8px;
      border: 1px solid #ddd;
      font-weight: 600;
    }
    tbody td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }
    table th:nth-child(1), table td:nth-child(1) { width: 30%; }
    table th:nth-child(2), table td:nth-child(2) { width: 18%; }
    table th:nth-child(3), table td:nth-child(3) { width: 18%; }
    table th:nth-child(4), table td:nth-child(4) { width: 18%; }
    table th:nth-child(5), table td:nth-child(5) { width: 16%; }
    .addBtn { background: #198754; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .delBtn { background: var(--danger); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    #clearAllBtn { background: var(--danger); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:8px; display:none; }
    @media (max-width: 900px) {
      .tables { flex-direction: column; }
      .col { width: 100%; }
      #reader { width: 100%; }
      #searchBar { width: 85%; }
    }
  </style>
</head>
<body>
  <h2>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
  <div id="status" class="inactive">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„</div>
  <div id="loginBox" aria-live="polite">
    <input id="passwordInput" type="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" aria-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <div class="numpad" style="margin-top:12px;">
      <button onclick="pressDigit('1')">1</button>
      <button onclick="pressDigit('2')">2</button>
      <button onclick="pressDigit('3')">3</button>
      <button onclick="pressDigit('4')">4</button>
      <button onclick="pressDigit('5')">5</button>
      <button onclick="pressDigit('6')">6</button>
      <button onclick="pressDigit('7')">7</button>
      <button onclick="pressDigit('8')">8</button>
      <button onclick="pressDigit('9')">9</button>
      <button onclick="backspacePass()">âŒ«</button>
      <button onclick="pressDigit('0')">0</button>
      <button onclick="submitPass()">â</button>
    </div>
    <div id="passError" role="alert" aria-live="assertive"></div>
  </div>
  <div id="app">
    <div class="searchRow" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«">
      <div class="searchControls">
        <input id="searchBar" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬" aria-label="Ø¨Ø­Ø«">
        <button id="focusToggleBtn" class="btn focus-on">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
      </div>
      <button id="searchBtn" class="btn primary" onclick="search(false)">Ø¨Ø­Ø«</button>
      <button id="clearBtn" class="btn ghost" onclick="clearSearch()">Ø­Ø°Ù</button>
      <button id="cameraBtn" class="btn camera" onclick="toggleScanner('qr')">ğŸ“· QR</button>
      <button id="scaleBtn" class="btn camera" onclick="toggleScaleFilter()">ğŸ“¶ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
    </div>
    <div id="reader" aria-hidden="true"></div>
    <div class="tables">
      <div class="col" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«">
        <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
        <table id="results" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="col" aria-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
        <div style="text-align:left; margin-bottom:6px;">
          <button id="clearAllBtn" onclick="clearAllSelected()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>
        <table id="finalResults" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let excelData = [];
    let qrScanner = null;
    let scanningMode = null;
    let scaleFilterActive = false;
    const correctPassword = "10100";

    const statusEl = document.getElementById('status');
    const loginBox = document.getElementById('loginBox');
    const passwordInput = document.getElementById('passwordInput');
    const passErrorBox = document.getElementById('passError');
    const app = document.getElementById('app');

    const searchBar = document.getElementById('searchBar');
    const resultsTbody = document.querySelector('#results tbody');
    const finalTbody = document.querySelector('#finalResults tbody');
    const reader = document.getElementById('reader');
    const clearAllBtnEl = document.getElementById('clearAllBtn');
    const scaleBtnEl = document.getElementById('scaleBtn');
    const focusToggleBtn = document.getElementById('focusToggleBtn');

    fetch("product.template(176).xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
          const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
          const firstSheet = workbook.SheetNames[0];
          excelData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
          statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„";
          statusEl.className = "active";
      })
      .catch(err => {
        statusEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„";
        statusEl.className = "inactive";
      });

    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitPass();
      } else {
        clearError();
      }
    });

    passwordInput.addEventListener('input', function() {
      clearError();
    });

    function pressDigit(d) {
      passwordInput.value = (passwordInput.value || "") + d;
      clearError();
    }

    function backspacePass() {
      passwordInput.value = (passwordInput.value || "").slice(0, -1);
      clearError();
    }

    function submitPass() {
      if ((passwordInput.value || "") === correctPassword) {
        loginBox.style.display = "none";
        app.style.display = "block";
        clearError();
        setTimeout(() => { if (searchBar) searchBar.focus(); }, 150);
      } else {
        showError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      }
    }

    function showError(msg) {
      if (!passErrorBox) return;
      passErrorBox.textContent = msg;
      passErrorBox.style.display = "block";
    }

    function clearError() {
      if (!passErrorBox) return;
      passErrorBox.textContent = "";
      passErrorBox.style.display = "none";
    }

    document.addEventListener('keydown', function(e) {
      if (app.style.display === 'block') {
        if (e.key === 'Enter') {
          if (document.activeElement === passwordInput) return;
          e.preventDefault();
          search(false);
        } else if (e.key === 'Delete') {
          if (finalTbody && finalTbody.rows.length > 0) {
            finalTbody.deleteRow(finalTbody.rows.length - 1);
            checkClearAllVisibility();
          }
        }
      }
    });

    function search(fromScanner = false, scannerType = '', value = '') {
      const query = fromScanner ? (value + "").trim().toLowerCase() : (searchBar.value || "").trim().toLowerCase();
      if (!query) {
        if (fromScanner) {
          searchBar.value = "";
          searchBar.dispatchEvent(new Event('input'));
        }
        return;
      }
      if (!Array.isArray(excelData) || excelData.length === 0) return;

      resultsTbody.innerHTML = "";

      excelData.forEach((row, idx) => {
        if (idx === 0) return;
        const a = (row[0] || "").toString().toLowerCase();
        const b = (row[1] || "").toString();
        const c = (row[2] || "").toString().toLowerCase();
        const d = (row[3] || "").toString().toLowerCase();

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          const tr = document.createElement('tr');
          const td0 = document.createElement('td'); td0.textContent = row[0] || ""; tr.appendChild(td0);
          const td1 = document.createElement('td'); td1.textContent = row[1] || ""; tr.appendChild(td1);
          const td2 = document.createElement('td'); td2.textContent = row[2] || ""; tr.appendChild(td2);
          const td3 = document.createElement('td'); td3.textContent = row[3] || ""; tr.appendChild(td3);
          const tdAction = document.createElement('td');
          if (!fromScanner) {
            const addBtn = document.createElement('button');
            addBtn.className = 'addBtn';
            addBtn.textContent = 'Ø¥Ø¶Ø§ÙØ©';
            addBtn.addEventListener('click', function() {
              const added = addToFinal(row);
              searchBar.value = "";
              searchBar.dispatchEvent(new Event('input'));
            });
            tdAction.appendChild(addBtn);
          } else {
            tdAction.textContent = '';
          }
          tr.appendChild(tdAction);
          resultsTbody.appendChild(tr);

          const exactMatch = ((d && d === query) || (c && c === query));
          if (exactMatch) {
            addToFinal(row);
            searchBar.value = "";
            searchBar.dispatchEvent(new Event('input'));
          }
        }
      });

      if (scaleFilterActive) {
        applyScaleFilterToTable(resultsTbody);
      }

      if (fromScanner) {
        searchBar.value = "";
        searchBar.dispatchEvent(new Event('input'));
      }
    }

    function clearSearch() {
      searchBar.value = "";
      resultsTbody.innerHTML = "";
    }

    function addToFinal(row) {
      const qrVal = (row[3] || "").toString();
      const codeVal = (row[2] || "").toString();

      const exists = Array.from(finalTbody.rows).some(r => {
        const rQr = (r.cells[3] && r.cells[3].textContent) || "";
        const rCode = (r.cells[2] && r.cells[2].textContent) || "";
        return (rQr === qrVal && qrVal !== "") || (rCode === codeVal && codeVal !== "");
      });
      if (exists) return false;

      const tr = document.createElement('tr');
      const td0 = document.createElement('td'); td0.textContent = row[0] || ""; tr.appendChild(td0);
      const td1 = document.createElement('td'); td1.textContent = row[1] || ""; tr.appendChild(td1);
      const td2 = document.createElement('td'); td2.textContent = row[2] || ""; tr.appendChild(td2);
      const td3 = document.createElement('td'); td3.textContent = row[3] || ""; tr.appendChild(td3);
      const tdDel = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.className = 'delBtn';
      delBtn.textContent = 'Ø­Ø°Ù';
      delBtn.addEventListener('click', function() {
        this.closest('tr').remove();
        checkClearAllVisibility();
      });
      tdDel.appendChild(delBtn);
      tr.appendChild(tdDel);
      finalTbody.appendChild(tr);
      checkClearAllVisibility();
      if (scaleFilterActive) applyScaleFilterToTable(finalTbody);
      return true;
    }

    function clearAllSelected() {
      finalTbody.innerHTML = "";
      checkClearAllVisibility();
    }

    function checkClearAllVisibility() {
      if (!finalTbody || finalTbody.rows.length === 0) {
        clearAllBtnEl.style.display = 'none';
      } else {
        clearAllBtnEl.style.display = 'inline-block';
      }
    }

    function toggleScaleFilter() {
      scaleFilterActive = !scaleFilterActive;
      scaleBtnEl.classList.toggle('scale-active', scaleFilterActive);
      applyScaleFilterToTable(resultsTbody);
      applyScaleFilterToTable(finalTbody);
      checkClearAllVisibility();
    }

    function applyScaleFilterToTable(tbody) {
      if (!tbody) return;
      const rows = Array.from(tbody.rows);
      rows.forEach(row => {
        const cell = row.cells[2];
        const val = cell ? (cell.textContent || "").trim() : "";
        row.style.display = (scaleFilterActive && val === "") ? 'none' : '';
      });
    }

    let lastScan = { text: null, time: 0 };

    function toggleScanner(mode) {
      if (scanningMode === mode) {
        stopScanner();
        return;
      }
      if (scanningMode) stopScanner();
      startScanner();
    }

    function startScanner() {
      scanningMode = 'qr';
      reader.style.display = 'block';
      const scanner = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };
      scanner.start(
        { facingMode: "environment" },
        config,
        (decodedText, decodedResult) => {
          handleDecodedFromScanner(String(decodedText || ""));
          stopScanner();
        }
      ).then(() => {
        qrScanner = scanner;
      }).catch(err => {
        alert("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
        reader.style.display = 'none';
        scanningMode = null;
      });
    }

    function handleDecodedFromScanner(decodedText) {
      if (!decodedText) {
        searchBar.value = "";
        searchBar.dispatchEvent(new Event('input'));
        return;
      }
      const now = Date.now();
      if (decodedText === lastScan.text && (now - lastScan.time) < 600) {
        searchBar.value = "";
        searchBar.dispatchEvent(new Event('input'));
        lastScan.time = now;
        return;
      }
      lastScan.text = decodedText;
      lastScan.time = now;
      search(true, 'qr', decodedText);
      searchBar.value = "";
      searchBar.dispatchEvent(new Event('input'));
      try { searchBar.blur(); } catch(e){}
    }

    function stopScanner() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          qrScanner.clear();
          qrScanner = null;
          reader.style.display = 'none';
          scanningMode = null;
        }).catch(err => {
          reader.style.display = 'none';
          scanningMode = null;
        });
      } else {
        reader.style.display = 'none';
        scanningMode = null;
      }
    }

    document.getElementById('searchBtn').addEventListener('click', () => search(false));
    document.getElementById('clearBtn').addEventListener('click', clearSearch);

    searchBar.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        search(false);
      }
    });

    searchBar.addEventListener('input', function () {
      const v = (searchBar.value || '').trim();
      if (v.length >= 26) {
        const first26 = v.slice(0, 26);
        if (/^\d{26}$/.test(first26)) {
          searchBar.value = "";
          searchBar.dispatchEvent(new Event('input'));
          setTimeout(() => {
            if (app.style.display === 'block' && autoFocusEnabled && Date.now() > skipFocusUntil) {
              try { searchBar.focus({preventScroll: true}); } catch(e) { searchBar.focus(); }
            }
          }, 20);
        }
      }
    });

    let autoFocusEnabled = true;
    let skipFocusUntil = 0;

    document.addEventListener('mousedown', function(e) {
      const interactive = e.target.closest('button, a, input, textarea, select, label, [contenteditable="true"]');
      if (interactive) {
        skipFocusUntil = Date.now() + 700;
      } else {
        setTimeout(() => {
          if (app.style.display === 'block' && document.activeElement !== searchBar && Date.now() > skipFocusUntil && autoFocusEnabled) {
            try { searchBar.focus({preventScroll: true}); } catch(e) { searchBar.focus(); }
          }
        }, 25);
      }
    }, true);

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        skipFocusUntil = Date.now() + 800;
      }
    });

    setInterval(function() {
      if (app.style.display === 'block' && Date.now() > skipFocusUntil && document.activeElement !== searchBar && autoFocusEnabled) {
        try { searchBar.focus({preventScroll: true}); } catch(e) { searchBar.focus(); }
      }
    }, 300);

    focusToggleBtn.addEventListener('click', function() {
      autoFocusEnabled = !autoFocusEnabled;
      if (autoFocusEnabled) {
        focusToggleBtn.classList.remove('focus-off');
        focusToggleBtn.classList.add('focus-on');
        focusToggleBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±ÙƒÙŠØ²';
        try { searchBar.focus(); } catch(e){}
      } else {
        focusToggleBtn.classList.remove('focus-on');
        focusToggleBtn.classList.add('focus-off');
        focusToggleBtn.textContent = 'ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ²';
      }
    });
  </script>

</body>
</html>
