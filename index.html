<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø¨Ø­Ø« ÙÙŠ Ù…Ù„Ù Excel Ù…Ø¹ Ø¨Ø§Ø±ÙƒÙˆØ¯</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; direction: rtl; }
    #searchBar { width: 50%; padding: 10px; font-size: 16px; margin-top: 20px; }
    table { width: 80%; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }

    /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø© */
    #statusBox {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: red;
      border: 2px solid #333;
    }

    /* Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    #cameraContainer {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 120px;
      height: 90px;
      border: 2px solid #333;
      overflow: hidden;
      background: #000;
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <h2>Ø¨Ø­Ø« ÙÙŠ Ù…Ù„Ù Excel Ù…Ø¹ Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>

  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø© -->
  <div id="statusBox" title="Ù…Ù„Ù Excel ØºÙŠØ± Ù…ØªØµÙ„"></div>

  <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
  <div id="cameraContainer">
    <video id="video" autoplay></video>
  </div>

  <select id="sheetSelect"></select>
  <br>
  <input type="text" id="searchBar" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„ÙˆØµÙ ÙˆØ§Ø¶ØºØ· Ø¥Ù†ØªØ±">
  <table id="results"></table>

  <script>
    let excelData = {};
    let selectedSheet = "";

    async function loadExcelFromGitHub() {
      try {
        const response = await fetch("data.xlsx"); // Ù„Ø§Ø²Ù… Ø§Ù„Ù…Ù„Ù ÙŠÙƒÙˆÙ† Ø¬Ù†Ø¨ index.html
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });

        const sheetSelect = document.getElementById('sheetSelect');
        sheetSelect.innerHTML = '';
        workbook.SheetNames.forEach(name => {
          let option = document.createElement('option');
          option.value = name;
          option.text = name;
          sheetSelect.appendChild(option);
        });
        selectedSheet = workbook.SheetNames[0];

        workbook.SheetNames.forEach(sheetName => {
          const sheet = workbook.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
          excelData[sheetName] = rows;
        });

        // âœ… Ø§Ù„Ù…Ù„Ù Ø§ØªØ­Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­
        const statusBox = document.getElementById("statusBox");
        statusBox.style.backgroundColor = "green";
        statusBox.title = "Ù…Ù„Ù Excel Ù…ØªØµÙ„";
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„:", err);
        const statusBox = document.getElementById("statusBox");
        statusBox.style.backgroundColor = "red";
        statusBox.title = "Ù…Ù„Ù Excel ØºÙŠØ± Ù…ØªØµÙ„";
      }
    }

    function search() {
      const query = document.getElementById('searchBar').value.trim().toLowerCase();
      if (!query || !selectedSheet) return;

      const rows = excelData[selectedSheet];
      const resultsTable = document.getElementById('results');
      resultsTable.innerHTML = '';

      let headerRow = `<tr><th>A</th><th>B</th><th>C</th><th>D</th></tr>`;
      resultsTable.innerHTML = headerRow;

      rows.forEach((row, index) => {
        if (index === 0) return;
        let a = (row[0] || "").toString().toLowerCase();
        let b = (row[1] || "").toString();
        let c = (row[2] || "").toString().toLowerCase();
        let d = (row[3] || "").toString().toLowerCase();

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          let tr = `<tr>
                      <td>${row[0] || ''}</td>
                      <td>${row[1] || ''}</td>
                      <td>${row[2] || ''}</td>
                      <td>${row[3] || ''}</td>
                    </tr>`;
          resultsTable.innerHTML += tr;
        }
      });
    }

    document.getElementById('sheetSelect').addEventListener('change', () => {
      selectedSheet = document.getElementById('sheetSelect').value;
    });
    document.getElementById('searchBar').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') search();
    });

    // ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    const video = document.getElementById("video");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", err));

    // ğŸ” Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (EAN ÙƒØ±Ù‚Ù… Ø¹Ø§Ø¯ÙŠ)
    function scanBarcode() {
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

      // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… jsQR (Ù…Ø¹Ø¸Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª / QR)
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        document.getElementById("searchBar").value = code.data;
        search();
      }
      requestAnimationFrame(scanBarcode);
    }

    video.addEventListener("play", () => {
      requestAnimationFrame(scanBarcode);
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.onload = loadExcelFromGitHub;
  </script>
</body>
</html>
